= Работа с сервисом Employee

`Employee` -- это веб-сервис для централизованного хранения и управления данными о сотрудниках организаций.

Раньше данные сотрудников дублировались в разных организациях одного пользователя: если сотрудник участвовал в нескольких организациях, его реквизиты приходилось заводить и обновлять в каждой отдельно. Это приводило к расхождениям и ошибкам в отчетности.

Сервис `Employee` решает эту проблему:

* Данные сотрудника создаются один раз и переиспользуются во всех организациях пользователя;
* При изменении данных сотрудника обновления автоматически учитываются во всех связанных организациях;
* Данные изолированы по пользователям: сущности одного пользователя недоступны другим.

== Основные сущности

С сервисом `Employee` можно работать двумя способами:

* Через REST API -- отправлять обычные HTTP-запросы (`GET`, `PUT`, `DELETE` и т.д.) к эндпоинтам сервиса. Этот способ подходит, если вы интегрируете свой сервис напрямую.
* Через клиентский интерфейс `IEmployeeClient` -- использовать готовый класс в коде. Он сам формирует и отправляет запросы к `Employee`, а вы работаете с методами и моделями (`Person`, `Position`, `Role`) как с обычными объектами.

Во всех случаях операции строятся вокруг трех основных сущностей:

* <<person,`Person`>> -- сотрудник;
* <<position,`Position`>> -- должность сотрудника в конкретной организации;
* <<role,`Role`>> -- роль сотрудника в организации (руководитель, отправитель и т.д.).

image:images/employee-diagram.png[]

Эти сущности используются для формирования отчетности и других внутренних процессов. Далее рассмотрим эти сущности подробнее.

[#person]
== Сущность `Person` (Сотрудник)

`Person` описывает физическое лицо: ФИО, дата рождения, контакты, ИНН, паспортные данные и т.п. Поля можно посмотреть в коде (`PersonProps`, `Person`).

Ключевые моменты:

* Каждый сотрудник имеет уникальный `Guid`;
* Данные хранятся в таблице `employee.persons`;
* Один и тот же `Person` может быть связан с несколькими организациями через `Position` и `Role`.

=== Методы для работы с `Person`

[cols="2a,1a,2a,1a",options="header"]
|===
^.^|Метод
^.^|Что делает
^.^|Основные параметры
^.^|Пример использования

|`SavePerson(Guid user, Person person)`
|Создает нового или обновляет существующего сотрудника. `Guid` сотрудника задается на стороне клиента.
|`user` -- идентификатор владельца данных; `person` -- объект с `Guid` и реквизитами.
|Сгенерировать `Guid`, заполнить `Person` и вызвать `SavePerson`. При повторном вызове с тем же `Guid` данные обновятся, дубликат не создастся. Корректное использование: `PUT /person/&#123;personId}` вместо `POST /person`.

|`GetPerson(Guid user, Guid personGuid)`
|Возвращает данные одного сотрудника.
|`user`; `personGuid` -- `Guid` сотрудника.
|Получить сотрудника по его идентификатору, чтобы показать карточку или подставить реквизиты в отчет.

|`GetPersons(Guid user, int? skip, int? take, IEnumerable<string> fieldsToInclude)`
|Возвращает список сотрудников пользователя с постраничным выводом.
|`user`; `skip`/`take` -- постраничный просмотр; `fieldsToInclude` -- какие поля включить.
|Загрузить первый экран списка сотрудников (`skip=0`, `take` -- нужное количество), при необходимости ограничив набор полей.

|`SearchPersons(Guid user, IFilter filter, int? skip, int? take, IEnumerable<string> fieldsToInclude)`
|Ищет сотрудников по заданным условиям.
|`user`; `filter` -- условия поиска; `skip`/`take`; `fieldsToInclude`.
|Найти сотрудников по ФИО, ИНН или другим атрибутам через единый сервис, не дублируя поиск в разных системах.

|`DeletePerson(Guid user, Guid personGuid)`
|Удаляет сотрудника.
|`user`; `personGuid`.
//TODO Нужно уточнить влияние на связанные `Position` и `Role`
|Удалить сотрудника, если он больше не используется.
|===

[#position]
== Сущность `Position` (Должность)

`Position` описывает, кем сотрудник числится в конкретной организации.

Основное:

* Поля: `Person` (`Guid` сотрудника), `Organization` (`Guid` организации), `Title` (должность);
* Данные хранятся в `employee.positions`;
* Ключ -- пара `Person + Organization`: у сотрудника может быть только одна должность в одной организации.

=== Методы для работы с `Position`

[cols="2a,1a,2a,1a",options="header"]
|===
^.^|Метод
^.^|Что делает
^.^|Основные параметры
^.^|Пример использования

|`SavePosition(Guid user, Position position)`
|Создает или обновляет должность сотрудника в организации (идемпотентно по паре `Person`+`Organization`).
|`user`; `position.Person`; `position.Organization`; `position.Title`.
|Назначить сотруднику должность в организации или изменить существующую (например, «Бухгалтер» → «Главный бухгалтер»).

|`GetPosition(Guid user, Guid person, Guid organization)`
|Возвращает должность конкретного сотрудника в конкретной организации.
|`user`; `person`; `organization`.
|Показать, кем сотрудник числится в выбранной организации (для интерфейса выбора ответственных лиц и т.п.).
|===

//TODO уточнить у разработчика
[NOTE]
Явного метода удаления должности в API нет -- при необходимости можно изменить должность вызовом `SavePosition` с новым значением `Title` или решить через удаление сотрудника либо организационных данных.

[#role]
== Сущность `Role` (Роль)

`Role` описывает функцию сотрудника в контексте организации (например, руководитель или отправитель отчетности). Имеет следующие особенности:

* Тип роли задается через `RoleType` (4 варианта: Руководитель, Главный бухгалтер, Уполномоченный представитель (отправитель), Индивидуальный предприниматель);
* Ключом записи служит комбинация `Organization + RoleType`;
* Значением являются:
** `Person` -- `Guid` сотрудника;
** `PositionOrganization` -- `Guid` организации, в которой этот сотрудник состоит по должности.
* Это позволяет назначить на роль в организации как ее собственного сотрудника, так и сотрудника из другой организации того же пользователя.

=== Методы для работы с `Role`

[cols="2a,1a,2a,2a",options="header"]
|===
^.^|Метод
^.^|Что делает
^.^|Основные параметры
^.^|Пример использования

|`SaveRole(Guid user, Role role)`
|Назначает или обновляет роль в организации. Если по ключу (`Organization`, `Type`) уже была роль, она будет заменена.
|`user`; `role.Organization`; `role.Type`; `role.Person`; `role.PositionOrganization`.
|Назначить руководителя, главбуха или отправителя для организации. При изменении -- просто вызвать `SaveRole` с новым сотрудником.

|`GetRole(Guid user, Guid organization, RoleType roleType)`
|Возвращает данные по конкретной роли в организации.
|`user`; `organization`; `roleType`.
|Узнать, кто сейчас является руководителем или отправителем в выбранной организации.

|`GetRoles(Guid user, Guid organization)`
|Возвращает все назначенные роли в одной организации в виде словаря `RoleType -> RoleResponse`.
|`user`; `organization`.
|Загрузить всю матрицу ответственных по организации: руководитель, главбух, отправитель и т.д.

|`GetRoles(Guid user)`
|Возвращает все роли по всем организациям пользователя. Структура: `OrganizationGuid -> (RoleType -> RoleResponse)`.
|`user`.
|Построить сводную картину: кто за что отвечает во всех организациях пользователя.

|`GetPersonRoles(Guid user, Guid person, int? skip, int? take)`
|Возвращает все роли, которые выполняет конкретный сотрудник.
|`user`; `person`; `skip`/`take`.
|Посмотреть, в каких организациях и в каких ролях задействован сотрудник (например, один человек отвечает за отправку отчетов в нескольких организациях).

|`DeleteRole(Guid user, Guid organization, RoleType roleType)`
|Удаляет конкретную роль в организации.
|`user`; `organization`; `roleType`.
|Снять назначение (например, временно оставить организацию без главбуха до назначения нового).

|`DeleteRoles(Guid user, Guid organization)`
|Удаляет все роли в организации.
|`user`; `organization`.
|Быстро очистить роли при закрытии или переразборе организации, не вызывая `DeleteRole` по одной.
|===

== Примеры запросов и ответов

Ниже приведены упрощенные примеры запросов и ответов, основанные на моделях `Person`, `Position` и `Role`. Они показывают общий формат взаимодействия с сервисом `Employee` через REST API.

[NOTE]
Примеры ниже иллюстрируют общий формат запросов и данных сущностей на основе моделей из кода (`Person`, `Position`, `Role`). Точные URL и полную структуру ответа (`EmployeeRequestResult` и служебные поля) нужно уточнить по фактическому API контракту.

._Пример: создание/обновление сотрудника (`SavePerson` / `PUT /person/&#123;personId}`)_
[%collapsible]
====
[cols="1a,1a",options="header"]
|===
|Запрос |Ответ

|[source,bash]
----
PUT /person/550e8400-e29b-41d4-a716-446655440000
Content-Type: application/json

{
  "Guid": "550e8400-e29b-41d4-a716-446655440000",
  "FullName": {
    "LastName": "Иванов",
    "FirstName": "Иван",
    "MiddleName": "Иванович"
  },
  "InnFl": "123456789012",
  "Phone": "+7-999-000-00-00",
  "Email": "ivanov@example.com"
}
----
|[source,http]
----
HTTP/1.1 200 OK
----
|===
====

._Пример: получение сотрудника (`GetPerson` / `GET /person/&#123;personId}`)_
[%collapsible]
====
[cols="1a,1a",options="header"]
|===
|Запрос |Ответ

|[source,bash]
----
GET /person/550e8400-e29b-41d4-a716-446655440000
Accept: application/json
----
|[source,json]
----
{
  "Guid": "550e8400-e29b-41d4-a716-446655440000",
  "FullName": {
    "LastName": "Иванов",
    "FirstName": "Иван",
    "MiddleName": "Иванович"
  },
  "InnFl": "123456789012",
  "Phone": "+7-999-000-00-00",
  "Email": "ivanov@example.com"
}
----
|===
====

._Пример: получение ролей в организации (`GetRoles(user, organization)`)_
[%collapsible]
====
[cols="1a,1a",options="header"]
|===
|Запрос |Ответ

|[source,bash]
----
GET /roles?organization=3fa85f64-5717-4562-b3fc-2c963f66afa6
Accept: application/json
----
|[source,json]
----
{
  "Director": {
    "Person": {
      "Guid": "11111111-1111-1111-1111-111111111111",
      "FullName": {
        "LastName": "Иванов",
        "FirstName": "Иван"
      }
    },
    "Position": {
      "Person": "11111111-1111-1111-1111-111111111111",
      "Organization": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "Title": "Директор"
    }
  },
  "ChiefAccountant": {
    "Person": {
      "Guid": "22222222-2222-2222-2222-222222222222",
      "FullName": {
        "LastName": "Петрова",
        "FirstName": "Анна"
      }
    },
    "Position": {
      "Person": "22222222-2222-2222-2222-222222222222",
      "Organization": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "Title": "Главный бухгалтер"
    }
  }
}
----
|===
====

== Как использовать сервис в своих приложениях

* Используйте `IEmployeeClient` как основной способ работы с сервисом `Employee` из кода.
* В каждый метод передается `user` (`Guid`) -- идентификатор владельца данных. Это связывает сотрудников, должности и роли с конкретным пользователем.
* Типичный сценарий:
** Создать `Person` через `SavePerson`;
** При необходимости назначить ему `Position` в нужной организации через `SavePosition`;
** Назначить этому сотруднику `Role` (например, сделать его отправителем отчетности) через `SaveRole`;
** Получать актуальные данные через методы `Get*` и при изменениях просто повторно вызывать `Save*` для тех же идентификаторов.

////
//TODO обычно я оставляю ссылки на полезные ресурсы в конце статьи, но у меня их нет :(. Хотел красивый итог для продажников, но документация внутренняя :(
== Итоги

Сервис `Employee` выступает единым источником данных о сотрудниках организаций с уже решеной задачей дублирования пользователей.

Используя описанные сценарии и методы, вы можете встроить `Employee` в свои сервисы и гарантировать актуальность кадровых данных во всех продуктах.
////